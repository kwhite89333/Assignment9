<html ng-app="Billboard">
    <head>
        <meta charset="utf-8">
        <!--
          File:  D:\H-Drive\91-461\461-2014-15f\assn09\MySolution\jmh-assn09-v4.html
          Jesse M. Heines, UMass Lowell Computer Science, heines@cs.uml.edu
          Copyright (c) 2014 by Jesse M. Heines.  All rights reserved.  May be freely 
            copied or excerpted for educational purposes with credit to the author.
          updated by JMH on November 29, 2014 at 3:29 PM
          
          Note the need to name the Billboard in the html ng-app attribute above
          if we're going to use it in the angular.module function below.
        -->
        <title>Assignment Billboard</title>

        <!-- this is version 1.2.27 -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js"></script>

        <!-- my own collection of utility functions -->
        <script src="utilities.js"></script>

        <script>
            "use strict";  // to ensure that all variables are declared before use

            // the number of the last column sorted, initialized to the Student Name column
            var lastSortColumnNo = 2;
            // a flag indicating whether the last sort was ascending (true) or descending (false)
            var lastSortDescending = false;

            // set up AngularJS module, note that name must be the same as that in the 
            //    ng-app attribute of the html tag above
            var myApp = angular.module('Billboard', []);

            // set a constant to the JSON file path
            myApp.constant("jsonUrl", "billboard_top_hits_2013.json");

            // add business logic to the app controller
            myApp.controller('BillboardCtrl',
                    /** Read JSON data using Ajax - adapted from Pro AngularJS, p. 149.
                     *  @param $scope  the standard AngularJS model scope
                     *  @param $http   the built-in AngularJS http object containing the get function
                     *  @param jsonURL the app constant containing the JSON file path (defined above)
                     */
                            function($scope, $http, jsonUrl) {
                                $scope.jsonData = {};              // initialize an object in the model's scope
                                $http.get(jsonUrl)                // perform the Ajax call
                                        .success(function(data) {      // execute this function if the Ajax succeeds
                                    $scope.jsonData.data = data;   // set the model's jsonData.data property to the
                                })                               //    data returned by the Ajax call
                                        .error(function(error) {      // execute this function if the Ajax fails
                                    $scope.jsonData.error = error; // set the model's jsonData.error property to the
                                });                             //    error returned by the Ajax call

                                // set the initial sort field (Artist Name) and sort order (ascending)
                                $scope.sortField = "artistName";
                                $scope.sortDescending = false;


                                /** 
                                 *  Sort column clicked in either ascending or descending order.
                                 *  Note that this could also be accomplished using the built-in AngularJS orderBy
                                 *    filter and manipulating the sort field and reverse parameters.
                                 *  Also note that this code could also have been incorporated into the ng-click 
                                 *    directives on the table's th elements, but doing it here gave me more central
                                 *    control, and I think that this function makes what's going on clearer and 
                                 *    therefore easier to maintain.
                                 *  @param colNo the number of the column header clicked
                                 */
                                $scope.sortColumn = function(colNo) {
                                    $scope.sortDescending = lastSortColumnNo === colNo && !lastSortDescending;
                                    // true to sort in descending order, false to sort in ascending order
                                    // will be false if sorting a new column or last sort was descending
                                    if (colNo === 2) {
                                        // this is the Artist Name column
                                        $scope.sortField = "artistName";
                                    } else if (colNo === 3) {
                                        // this is the Song Title column
                                        $scope.sortField = "songTitle";
                                    } else if (colNo === 4) {
                                        // this is the Weeks On Top column
                                        $scope.sortField = "weeksOnTop";
                                    }
                                    // save the sort paramesters for the next click
                                    lastSortDescending = $scope.sortDescending;
                                    lastSortColumnNo = colNo;
                                };
                            }
                    );
                    $scope.addRecord = function() {
                        var objToAdd = {
                            "index": $scope.jsonData.data.length
                        };
                    };
        </script>

        <!-- filter functions for this app -->
        <script src="filters.js"></script>

        <!-- CSS for this app -->
        <link type="text/css" rel="stylesheet" href="stylesheet.css">
    </head>

    <body>
        <!-- the main view, controlled by AngularJS -->
        <div ng-controller="BillboardCtrl">            

            <!-- directions -->
            <p><em>Click either green header row cell to sort the list.</em></p>

            <!-- 
              show number of records in the JSON data
                http://stackoverflow.com/questions/19956074/how-can-i-show-a-count-of-rows-from-an-ng-repeat
              show date and time
                http://stackoverflow.com/questions/22962468/angularjs-display-current-date
                https://docs.angularjs.org/api/ng/filter/date 
            -->

            <!-- the table controlled by the AngularJS controller -->
            <table id="tblBillboard">
                <!-- the column heads -->
                <thead>
                    <tr>
                        <th>#</th>
                        <th ng-click="sortColumn(2)">Artist's<br>Name</th>
                        <th ng-click="sortColumn(3)">Song<br>Title</th>
                        <th ng-click="sortColumn(4)">Weeks<br>On Top</th>
                    </tr>
                </thead>
                <!-- 
                  AngularJS template for each row of the table 
                  the ng-model attribute causes the data to be re-rendered when the jsonData changes
                -->
                <tbody ng-model="jsonData">
                    <tr ng-repeat="oneSubmit in jsonData.data.SONGS | orderBy : sortField : sortDescending">

                        <!-- the built-in AngularJS loop index -->
                        <td>{{$index | increment}}</td>

                        <!-- the student's first and last names only, in LastName, FirstName format -->
                        <td>{{oneSubmit.artistName}}</td>

                        <td>{{oneSubmit.songTitle}}</td>

                        <!-- 
                          According to:
                            https://docs.angularjs.org/api/ng/filter/date
                          the following statement does not work because the AngularJS date filter needs
                          the date as a Date object, milliseconds (string or number), or various ISO 8601
                          datetime string formats (e.g., yyyy-MM-ddTHH:mm:ss.sssZ and its shorter
                          versions like yyyy-MM-ddTHH:mmZ, yyyy-MM-dd or yyyyMMddTHHmmssZ).
                            <td>{{oneSubmit.timestamp | date:"MMM d"}}</td>
                        -->
                        <!--
                          The following statement uses a custom filter to extract just the month and day
                          from the Java-style data string in the JSON file.
                        -->
                        <!-- <td>{{oneSubmit.timestamp | substring:4:11}}</td> -->
                        <!--
                          However, given that we have the number of milliseconds that the time stamp
                          represents, we can use the built-in AngularJS date filter on that.
                        -->
                        <td>{{oneSubmit.weeksOnTop}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>
